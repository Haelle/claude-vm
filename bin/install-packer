#!/bin/bash
# Installe Packer et les dépendances QEMU/KVM nécessaires au build
set -e

echo "=== Installation des prérequis pour claude_vm ==="

# --- Packer ---
if command -v packer &> /dev/null; then
    echo "[OK] Packer déjà installé: $(packer --version)"
else
    echo "[*] Installation de Packer..."
    sudo apt-get update -qq
    sudo apt-get install -y -qq gnupg software-properties-common
    wget -qO- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
    echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" \
        | sudo tee /etc/apt/sources.list.d/hashicorp.list > /dev/null
    sudo apt-get update -qq
    sudo apt-get install -y -qq packer
    echo "[OK] Packer installé: $(packer --version)"
fi

# --- QEMU/KVM ---
if command -v qemu-system-x86_64 &> /dev/null; then
    echo "[OK] QEMU déjà installé: $(qemu-system-x86_64 --version | head -1)"
else
    echo "[*] Installation de QEMU/KVM..."
    sudo apt-get update -qq
    sudo apt-get install -y -qq qemu-kvm qemu-utils
    echo "[OK] QEMU installé"
fi

# --- Accès /dev/kvm ---
if [ -e /dev/kvm ]; then
    if [ -w /dev/kvm ]; then
        echo "[OK] Accès à /dev/kvm"
    else
        echo "[*] Ajout de $USER au groupe kvm..."
        sudo usermod -aG kvm "$USER"
        echo "[!] Déconnectez-vous et reconnectez-vous pour que le changement prenne effet."
    fi
else
    echo "[!] /dev/kvm n'existe pas. Vérifiez que la virtualisation est activée dans le BIOS."
fi

# --- virt-manager ---
if command -v virt-manager &> /dev/null; then
    echo "[OK] virt-manager déjà installé"
else
    echo "[*] Installation de virt-manager..."
    sudo apt-get install -y -qq virt-manager
    echo "[OK] virt-manager installé"
fi

# --- libvirt daemon ---
if command -v virsh &> /dev/null; then
    echo "[OK] libvirt déjà installé: $(virsh --version)"
else
    echo "[*] Installation de libvirt..."
    sudo apt-get install -y -qq libvirt-daemon-system libvirt-clients
    echo "[OK] libvirt installé"
fi

# --- Accès libvirt ---
if id -nG "$USER" | grep -qw libvirt; then
    echo "[OK] $USER est dans le groupe libvirt"
else
    echo "[*] Ajout de $USER au groupe libvirt..."
    sudo usermod -aG libvirt "$USER"
    echo "[!] Déconnectez-vous et reconnectez-vous pour que le changement prenne effet."
fi

# --- virtiofsd (pour les dossiers partagés host <-> VM) ---
if command -v virtiofsd &> /dev/null; then
    echo "[OK] virtiofsd déjà installé"
else
    echo "[*] Installation de virtiofsd..."
    sudo apt-get install -y -qq virtiofsd
    echo "[OK] virtiofsd installé"
fi

# --- mkpasswd (paquet whois) ---
if command -v mkpasswd &> /dev/null; then
    echo "[OK] mkpasswd déjà installé"
else
    echo "[*] Installation de mkpasswd (paquet whois)..."
    sudo apt-get install -y -qq whois
    echo "[OK] mkpasswd installé"
fi

echo ""
echo "=== Prérequis installés ==="
echo "Vous pouvez maintenant lancer le build: cd packer && ./build.sh"
